<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Capture caméra arrière</title>
  <meta name="theme-color" content="#000000"> <!-- Barre d'adresse noire sur mobile -->
  <style>
    html, body {
      margin: 0;
      background: black;
      width: 100vw;
      height: 100vh;
      overflow: hidden;
      touch-action: manipulation;
    }
    #video {
      display: none;
    }
    #loading {
      color: white;
      font-family: sans-serif;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 18px;
    }
  </style>
</head>
<body>

<video id="video" autoplay muted playsinline></video>
<div id="loading" style="display:none;">Conversion en MP4...</div>

<script src="https://unpkg.com/@ffmpeg/ffmpeg@0.12.6/dist/ffmpeg.min.js"></script>

<script>
  const { createFFmpeg, fetchFile } = FFmpeg;
  const ffmpeg = createFFmpeg({ log: false });

  const video = document.getElementById("video");
  const loading = document.getElementById("loading");

  let mediaRecorder;
  let recordedChunks = [];

  async function startRecording() {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        video: { facingMode: { ideal: "environment" } },
        audio: false
      });

      video.srcObject = stream;

      mediaRecorder = new MediaRecorder(stream, { mimeType: "video/webm" });

      mediaRecorder.ondataavailable = e => {
        if (e.data.size > 0) recordedChunks.push(e.data);
      };

      mediaRecorder.onstop = async () => {
        loading.style.display = "block";

        const webmBlob = new Blob(recordedChunks, { type: "video/webm" });
        const webmBuffer = await webmBlob.arrayBuffer();

        await ffmpeg.load();
        ffmpeg.FS('writeFile', 'input.webm', new Uint8Array(webmBuffer));

        await ffmpeg.run('-i', 'input.webm', '-c:v', 'libx264', '-preset', 'veryfast', '-crf', '23', 'output.mp4');

        const mp4Data = ffmpeg.FS('readFile', 'output.mp4');
        const mp4Blob = new Blob([mp4Data.buffer], { type: 'video/mp4' });
        const mp4Url = URL.createObjectURL(mp4Blob);

        const a = document.createElement('a');
        a.href = mp4Url;
        a.download = 'video_convertie.mp4';
        a.click();

        URL.revokeObjectURL(mp4Url);
        loading.style.display = "none";
      };

      mediaRecorder.start();
    } catch (err) {
      alert("Erreur caméra : " + err.message);
    }
  }

  function stopRecording() {
    if (mediaRecorder && mediaRecorder.state !== "inactive") {
      mediaRecorder.stop();
      const tracks = video.srcObject.getTracks();
      tracks.forEach(track => track.stop());
    }
  }

  function goFullscreen() {
    const docElm = document.documentElement;
    if (docElm.requestFullscreen) docElm.requestFullscreen();
    else if (docElm.webkitRequestFullscreen) docElm.webkitRequestFullscreen();
    else if (docElm.mozRequestFullScreen) docElm.mozRequestFullScreen();
    else if (docElm.msRequestFullscreen) docElm.msRequestFullscreen();
  }

  document.body.addEventListener("click", () => {
    stopRecording();
  });

  window.addEventListener("load", async () => {
    goFullscreen();
    await startRecording();
  });
</script>

</body>
</html>
